[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Blob Detect | Dynamic PA | Z-Watcher
# =========================================================
#  USER CONFIGURATION (edit these variables)
#  NOTE: This script is designed for E3D Revo hotends only
# =========================================================
#
# HOTEND TYPE (Revo Only)
# -----------------------
# Set to True for Revo HF (High Flow) nozzles
# Set to False for Revo Standard nozzles
# This affects the flow gate threshold:
#   - Revo HF: enables boost only above 15mm³/s (matches HF flow capacity)
#   - Revo Std: enables boost above 8mm³/s (matches standard flow capacity)
variable_use_high_flow_nozzle: True
#
# SENSOR BASELINE (StallGuard calibration)
# ----------------------------------------
# Run AT_CHECK_BASELINE at your typical print temp to find your baseline value.
# This is the SG_RESULT reading when extruding freely with no resistance.
# Typical values:
#   - LDO Pancake stepper (small motor): ~16
#   - Standard NEMA17 stepper: ~60-80
#   - High-torque NEMA17: ~100+
# Lower baseline = more sensitive to load changes (smaller motors)
variable_sensor_baseline: 16
#
# NOISE FILTER
# ------------
# Minimum strain delta required before applying load-based temperature boost.
# Filters out normal fluctuations in StallGuard readings.
# Set higher for noisier steppers, lower for quieter ones.
#   - LDO Pancake / quiet steppers: 2
#   - Standard NEMA17: 10
#   - Noisy/vibrating setups: 15+
variable_noise_filter: 2
#
# CRASH THRESHOLD
# ---------------
# How much sudden load change triggers "blob detection" (surface defect warning).
# If load jumps by more than this between samples, it counts as a crash event.
# Too low = false positives on normal extrusion variation.
# Too high = misses actual issues.
#   - LDO Pancake: 10
#   - Standard NEMA17: 20
variable_crash_threshold: 10
#
# ADVANCED TUNING
# ---------------
# flow_smoothing: Exponential smoothing factor for volumetric flow (0.0-1.0)
#   - Higher = more smoothing, slower response, less jitter
#   - Lower = faster response, may oscillate on variable flow
#   - Default 0.5 is a good balance
variable_flow_smoothing: 0.5
#
# max_boost_limit: Maximum temperature boost above base temp (°C)
#   - Safety cap to prevent runaway heating
#   - 50°C allows base 200 to reach 250 max
variable_max_boost_limit: 50.0
#
# ramp_rate_rise: Max temp increase per loop cycle (°C/second)
#   - Higher = faster response to increased flow demand
#   - Too high may overshoot on brief speed bursts
variable_ramp_rate_rise: 2.0
#
# ramp_rate_fall: Max temp decrease per loop cycle (°C/second)
#   - Lower = slower cooldown, maintains heat during brief pauses
#   - Higher = faster return to base temp, saves energy
#   - Keep lower than rise rate for stability
variable_ramp_rate_fall: 0.2
#
# THERMAL SAFETY
# --------------
# thermal_runaway_threshold: Max deviation from target before emergency stop (°C)
#   - If actual temp exceeds target + this value, system triggers emergency
#   - Set based on your hotend's thermal characteristics
#   - 15°C is conservative, increase for hotends with slow response
variable_thermal_runaway_threshold: 15.0
#
# thermal_undertemp_threshold: Min temp below target before warning (°C)
#   - If actual temp drops below target - this value during active printing,
#     the system will reduce boost and warn
#   - Helps detect heater issues or cooling problems
variable_thermal_undertemp_threshold: 10.0
#
# thermal_check_interval: Seconds between thermal safety checks
#   - Lower = more responsive but more CPU usage
variable_thermal_check_interval: 2.0
#
# =========================================================
variable_current_boost: 0.0
variable_last_load_val: 0
variable_layer_crash_count: 0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_slowdown_layers_left: 0
variable_slowdown_active: False
variable_last_vol_flow: 0.0
variable_thermal_fault_count: 0
variable_last_thermal_check: 0.0 

gcode:
    # =========================================================
    #  READ CONFIGURATION FROM VARIABLES ABOVE
    # =========================================================
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set use_high_flow_nozzle = cfg.use_high_flow_nozzle %}
    
    # Sensor baseline: prefer saved (calibrated) value, fallback to config
    {% set vars = printer.save_variables.variables %}
    {% set sensor_baseline = vars.sensor_baseline|default(cfg.sensor_baseline)|int %}
    
    {% set noise_filter = cfg.noise_filter %}
    {% set crash_threshold = cfg.crash_threshold %}
    {% set flow_smoothing = cfg.flow_smoothing %}
    {% set max_boost_limit = cfg.max_boost_limit %}
    {% set ramp_rate_rise = cfg.ramp_rate_rise %}
    {% set ramp_rate_fall = cfg.ramp_rate_fall %}
    {% set thermal_runaway_threshold = cfg.thermal_runaway_threshold %}
    {% set thermal_undertemp_threshold = cfg.thermal_undertemp_threshold %}

    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # Auto-Calculate Flow Gate
    {% if use_high_flow_nozzle %}
        {% set min_flow_mm3 = 15.0 %}
    {% else %}
        {% set min_flow_mm3 = 8.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            _AT_EVALUATE_LAYER
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: BLOB DETECTION ---
        {% set load_val = printer["extruder_monitor"].load|default(0)|int %}
        {% set predicted_rate = printer["extruder_monitor"].predicted_extrusion_rate|default(0.0)|float %}
        {% set last_load = printer["gcode_macro _AUTO_TEMP_CORE"].last_load_val %}
        {% set load_delta = (last_load - load_val)|abs %}

        {% if filament_speed > 2.0 and load_delta > crash_threshold %}
            {% set current_crashes = printer["gcode_macro _AUTO_TEMP_CORE"].layer_crash_count %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE={current_crashes + 1}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_load_val VALUE={load_val}

        # --- C: CALCULATE BOOST (Velocity + Acceleration) ---
        
        # 1. Calculate Flow
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        
        # 2. Smoothing (moved up so smooth_vol_flow is available for later calculations)
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}
        
        # 3. ACCELERATION KICK (Predictive Boost)
        # Calculate how fast the flow is changing
        {% set flow_accel = raw_vol_flow - last_vol_flow %}
        
        # If accelerating hard (positive change), add a temp kick
        {% set accel_boost = 0.0 %}
        {% if flow_accel > 2.0 %}
            # Add 2C boost for every 1mm3/s of acceleration
            {% set accel_boost = flow_accel * 2.0 %}
        {% endif %}

        # 4. LOOKAHEAD BOOST (Predictive from upcoming G-code)
        # predicted_rate is in mm/s filament; convert to approx vol flow (mm3/s)
        {% set predicted_vol_flow = predicted_rate * 2.405 %}
        {% set lookahead_boost = 0.0 %}
        {% if predicted_vol_flow > smooth_vol_flow %}
            # Upcoming extrusion is faster than current — pre-heat
            {% set lookahead_delta = predicted_vol_flow - smooth_vol_flow %}
            # 1C per 2 mm3/s predicted increase (tunable)
            {% set lookahead_boost = lookahead_delta * 0.5 %}
        {% endif %}

        # 5. Standard Boost
        {% set speed_k = vars.material_flow_k|default(0.0)|float %}
        
        # Gated Logic
        {% if smooth_vol_flow < min_flow_mm3 %}
            {% set speed_boost = 0.0 %}
        {% else %}
            {% set speed_boost = smooth_vol_flow * speed_k %}
        {% endif %}

        # 6. Strain Boost
        {% set board_temp = 35.0 %}
        {% if 'temperature_sensor Toolhead_Temp' in printer %}
            {% set board_temp = printer['temperature_sensor Toolhead_Temp'].temperature|float %}
        {% elif 'temperature_sensor mcu_temp' in printer %}
             {% set board_temp = printer['temperature_sensor mcu_temp'].temperature|float %}
        {% endif %}

        {% set corrected_load = load_val + ((board_temp - 35.0) * 0.4) %}
        {% if corrected_load < 0 %} {% set corrected_load = 0 %} {% endif %}
        {% set strain = sensor_baseline - corrected_load %}
        {% if strain < noise_filter %} {% set strain = 0 %} {% endif %}
        {% set load_boost = strain * vars.material_viscosity_k|default(0.0)|float %}

        # --- D: SMOOTHING & RAMPING ---
        
        # Add Accel Boost + Lookahead Boost to the target
        {% set raw_boost_target = speed_boost + load_boost + accel_boost + lookahead_boost %}
        
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        # Linear Ramp Safety
        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}
        
        # --- E: APPLY ---
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}

        {% if load_val != -1 %}
            {% set temp_diff = (new_target - current_setpoint)|abs %}
            {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}
        {% endif %}

        # --- F: THERMAL SAFETY CHECK ---
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set target_temp = printer.extruder.target|float %}
        {% set temp_deviation = actual_temp - target_temp %}
        
        # Check for thermal runaway (temp too high)
        {% if temp_deviation > thermal_runaway_threshold %}
            {% set fault_count = printer["gcode_macro _AUTO_TEMP_CORE"].thermal_fault_count + 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE={fault_count}
            
            {% if fault_count >= 3 %}
                # Multiple consecutive faults - emergency shutdown
                _AT_THERMAL_EMERGENCY reason="RUNAWAY" actual={actual_temp} target={target_temp}
            {% else %}
                # Single fault - reduce boost and warn
                RESPOND TYPE=error MSG="THERMAL WARNING: Temp {actual_temp}C exceeds target {target_temp}C by {temp_deviation|round(1)}C"
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
                M104 S{saved_base|int}  ; Drop to base temp immediately
            {% endif %}
        
        # Check for undertemp (heater not keeping up)
        {% elif temp_deviation < (0 - thermal_undertemp_threshold) %}
            RESPOND TYPE=echo MSG="THERMAL NOTICE: Temp {actual_temp}C is {(0-temp_deviation)|round(1)}C below target. Heater may be struggling."
            # Don't add more boost if heater can't keep up - reduce demand
            {% if smooth_boost > 10 %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost * 0.5}
            {% endif %}
        
        {% else %}
            # Temp is within safe range - reset fault counter
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
        {% endif %}

        # Pressure Advance
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if base_pa > 0 %}
            {% set pa_multiplier = 1.0 - (smooth_boost * 0.01) %}
            {% if pa_multiplier < 0.5 %} {% set pa_multiplier = 0.5 %} {% endif %}
            {% set new_pa = base_pa * pa_multiplier %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.01 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. EVALUATION LOGIC
# =========================================================
[gcode_macro _AT_EVALUATE_LAYER]
description: Internal - Decides if the last layer was bad
gcode:
    {% set macro_vars = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set crashes = macro_vars.layer_crash_count %}
    {% set CRASH_LIMIT = 3 %} 
    
    {% if crashes > CRASH_LIMIT %}
        RESPOND TYPE=error MSG="Auto-Temp: Surface Defects Detected ({crashes} spikes). Slowing down."
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=3
        
        {% if not macro_vars.slowdown_active %}
            M220 S50 ; Drop to 50% Speed
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=True
        {% endif %}
        
    {% else %}
        {% if macro_vars.slowdown_layers_left > 0 %}
            {% set remaining = macro_vars.slowdown_layers_left - 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE={remaining}
            
            {% if remaining == 0 %}
                RESPOND MSG="Auto-Temp: Stability restored. Resuming 100% speed."
                M220 S100
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
            {% endif %}
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0

# =========================================================
#  2b. THERMAL SAFETY
# =========================================================
[gcode_macro _AT_THERMAL_EMERGENCY]
description: Emergency thermal shutdown - called when runaway detected
gcode:
    {% set reason = params.REASON|default("UNKNOWN")|string %}
    {% set actual = params.ACTUAL|default(0)|float %}
    {% set target = params.TARGET|default(0)|float %}
    
    # Immediately disable auto-temp
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    
    # Turn off heater (set to 0)
    M104 S0
    
    # Pause print
    PAUSE
    
    # Alert user
    RESPOND TYPE=error MSG="!!! THERMAL EMERGENCY !!!"
    RESPOND TYPE=error MSG="Reason: {reason}"
    RESPOND TYPE=error MSG="Actual: {actual}C | Target: {target}C"
    RESPOND TYPE=error MSG="Heater OFF - Print PAUSED - Auto-Temp DISABLED"
    RESPOND TYPE=error MSG="Check hotend and thermistor before resuming!"
    
    M117 THERMAL EMERGENCY - CHECK HOTEND!

[gcode_macro AT_THERMAL_STATUS]
description: Display current thermal safety status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set actual = printer.extruder.temperature|float %}
    {% set target = printer.extruder.target|float %}
    {% set base = vars.base_print_temp|default(0)|float %}
    {% set boost = cfg.current_boost %}
    {% set faults = cfg.thermal_fault_count %}
    
    {% set deviation = actual - target %}
    {% set runaway_limit = cfg.thermal_runaway_threshold %}
    {% set undertemp_limit = cfg.thermal_undertemp_threshold %}
    
    RESPOND MSG="===== THERMAL STATUS ====="
    RESPOND MSG="Actual: {actual|round(1)}C | Target: {target|round(1)}C"
    RESPOND MSG="Base: {base|round(1)}C | Boost: +{boost|round(1)}C"
    RESPOND MSG="Deviation: {deviation|round(1)}C"
    RESPOND MSG="Limits: Runaway +{runaway_limit}C | Undertemp -{undertemp_limit}C"
    RESPOND MSG="Fault Count: {faults}/3"
    {% if vars.at_enabled|default(False) %}
        RESPOND MSG="Status: ACTIVE"
    {% else %}
        RESPOND MSG="Status: DISABLED"
    {% endif %}
    RESPOND MSG="=========================="

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    M220 S100
    RESPOND MSG="Auto-Temp: State reset complete"

    
[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_VISC_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_CHECK_BASELINE]
description: Manual baseline check (legacy) - shows SG values during extrusion
gcode:
    {% set temp = params.TEMP|default(220)|int %}
    M117 Heating to {temp}C...
    M109 S{temp}
    M117 Extruding FAST (50mm/s)...
    G91
    G1 E100 F3000 
    G90
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    M117 Done. Note the SG_RESULT values.

[gcode_macro AT_AUTO_CALIBRATE]
description: Automatic baseline calibration - heats, extrudes, samples, and saves
gcode:
    {% set temp = params.TEMP|default(220)|int %}
    {% set extrude_length = params.LENGTH|default(50)|int %}
    {% set num_samples = params.SAMPLES|default(10)|int %}
    
    RESPOND MSG="Auto-Calibrate: Starting baseline calibration..."
    
    # Heat and wait
    M117 Heating to {temp}C...
    M109 S{temp}
    G4 P2000  ; Wait 2s for temp to stabilize
    
    # Start calibration
    CALIBRATE_BASELINE
    
    # Extrude and sample
    M117 Extruding and sampling...
    G91  ; Relative positioning
    
    # Calculate extrusion per sample
    {% set e_per_sample = (extrude_length / num_samples)|round(2) %}
    {% set feedrate = 1500 %}  ; 25mm/s - moderate extrusion speed
    
    # Extrude in chunks, sampling after each
    {% for i in range(num_samples) %}
        G1 E{e_per_sample} F{feedrate}
        G4 P200  ; Brief pause for SG to settle
        SAMPLE_LOAD
    {% endfor %}
    
    G90  ; Absolute positioning
    
    # Finish and calculate
    FINISH_CALIBRATION
    
    M117 Calibration complete!
    RESPOND MSG="Auto-Calibrate: Done! See console for baseline value."
    RESPOND MSG="Run: SAVE_VARIABLE VARIABLE=sensor_baseline VALUE=<value> to save"

[gcode_macro AT_INIT_MATERIAL]
description: Logic to set K-values and PA based on material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string %}
    
    # Read hotend type from shared config variable in _AUTO_TEMP_CORE
    {% set use_hf = printer["gcode_macro _AUTO_TEMP_CORE"].use_high_flow_nozzle %}
    
    # Defaults
    {% set load_k = 0.0 %}
    {% set speed_k = 0.0 %}
    {% set pa_val = 0.0 %}
    {% set max_temp_safety = 300 %}

    # --- PLA LOGIC ---
    {% if 'PLA' in material %}
        {% set pa_val = 0.040 %}
        {% if use_hf %}
            # High Flow Revo (Aggressive)
            {% set load_k = 0.60 %}
            {% set speed_k = 0.80 %}
            {% set max_temp_safety = 235 %}
        {% else %}
            # Standard Revo (Conservative for small prints)
            # Reduced K values to avoid temp creep on benchy-sized models
            {% set load_k = 0.25 %}
            {% set speed_k = 0.40 %} 
            {% set max_temp_safety = 235 %}
        {% endif %}

    # --- PETG LOGIC ---
    {% elif 'PETG' in material %}
        {% set pa_val = 0.060 %}
        {% if use_hf %}
            # High Flow Revo (Turbo Mode)
            {% set load_k = 0.80 %}
            {% set speed_k = 1.20 %}
            {% set max_temp_safety = 280 %}
        {% else %}
            # Standard Revo (Pressure Relief)
            {% set load_k = 0.60 %}
            {% set speed_k = 1.00 %}
            {% set max_temp_safety = 265 %}
        {% endif %}

    # --- ABS LOGIC ---
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set pa_val = 0.050 %}
        {% set load_k = 0.20 %}
        {% set speed_k = 0.80 %}
        {% set max_temp_safety = 290 %}
        
    # --- TPU LOGIC ---
    {% elif 'TPU' in material %}
        {% set pa_val = 0.20 %} 
        {% set max_temp_safety = 240 %}
    {% endif %}

    # --- APPLY ---
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
    {% endif %}

    {% if load_k > 0 or speed_k > 0 %}
        AT_SET_VISC_K K={load_k}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material})"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"
    {% endif %}
