[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Blob Detect | Dynamic PA | Z-Watcher
# =========================================================
#  USER CONFIGURATION (edit these variables)
#  NOTE: This script is designed for E3D Revo hotends only
# =========================================================
#
# HOTEND TYPE (Revo Only)
# -----------------------
# Set to True for Revo HF (High Flow) nozzles
# Set to False for Revo Standard nozzles
# This affects the flow gate threshold:
#   - Revo HF: enables boost only above 15mm³/s (matches HF flow capacity)
#   - Revo Std: enables boost above 8mm³/s (matches standard flow capacity)
variable_use_high_flow_nozzle: True
#
# SENSOR BASELINE (StallGuard calibration)
# ----------------------------------------
# Run AT_CHECK_BASELINE at your typical print temp to find your baseline value.
# This is the SG_RESULT reading when extruding freely with no resistance.
# Typical values:
#   - LDO Pancake stepper (small motor): ~16
#   - Standard NEMA17 stepper: ~60-80
#   - High-torque NEMA17: ~100+
# Lower baseline = more sensitive to load changes (smaller motors)
variable_sensor_baseline: 16
#
# NOISE FILTER
# ------------
# Minimum strain delta required before applying load-based temperature boost.
# Filters out normal fluctuations in StallGuard readings.
# Set higher for noisier steppers, lower for quieter ones.
#   - LDO Pancake / quiet steppers: 2
#   - Standard NEMA17: 10
#   - Noisy/vibrating setups: 15+
variable_noise_filter: 2
#
# CRASH THRESHOLD
# ---------------
# How much sudden load change triggers "blob detection" (surface defect warning).
# If load jumps by more than this between samples, it counts as a crash event.
# Too low = false positives on normal extrusion variation.
# Too high = misses actual issues.
#   - LDO Pancake: 10
#   - Standard NEMA17: 20
variable_crash_threshold: 10
#
# ADVANCED TUNING
# ---------------
# flow_smoothing: Exponential smoothing factor for volumetric flow (0.0-1.0)
#   - Higher = more smoothing, slower response, less jitter
#   - Lower = faster response, may oscillate on variable flow
#   - Default 0.5 is a good balance
variable_flow_smoothing: 0.5
#
# max_boost_limit: Maximum temperature boost above base temp (°C)
#   - Safety cap to prevent runaway heating
#   - 50°C allows base 200 to reach 250 max
variable_max_boost_limit: 50.0
#
# ramp_rate_rise: Max temp increase per loop cycle (°C/second)
#   - Higher = faster response to increased flow demand
#   - Too high may overshoot on brief speed bursts
variable_ramp_rate_rise: 2.0
#
# ramp_rate_fall: Max temp decrease per loop cycle (°C/second)
#   - Lower = slower cooldown, maintains heat during brief pauses
#   - Higher = faster return to base temp, saves energy
#   - Keep lower than rise rate for stability
variable_ramp_rate_fall: 0.2
#
# THERMAL SAFETY
# --------------
# thermal_runaway_threshold: Max deviation from target before emergency stop (°C)
#   - If actual temp exceeds target + this value, system triggers emergency
#   - Set based on your hotend's thermal characteristics
#   - 15°C is conservative, increase for hotends with slow response
variable_thermal_runaway_threshold: 15.0
#
# thermal_undertemp_threshold: Min temp below target before warning (°C)
#   - If actual temp drops below target - this value during active printing,
#     the system will reduce boost and warn
#   - Helps detect heater issues or cooling problems
variable_thermal_undertemp_threshold: 10.0
#
# thermal_check_interval: Seconds between thermal safety checks
#   - Lower = more responsive but more CPU usage
variable_thermal_check_interval: 2.0
#
# OOZE PREVENTION
# ---------------
# ooze_prevention_enabled: Enable/disable ooze prevention feature
#   - When enabled, temp drops during long travels to prevent oozing
variable_ooze_prevention_enabled: True
#
# ooze_travel_threshold: Minimum travel distance (mm) to trigger temp drop
#   - Shorter travels won't trigger ooze prevention
#   - 20mm is a good starting point
variable_ooze_travel_threshold: 20.0
#
# ooze_temp_drop: How many °C to drop during long travels
#   - Higher = less ooze but slower recovery
#   - 10-15°C is typical
variable_ooze_temp_drop: 10.0
#
# ooze_preheat_distance: mm before extrusion resumes to start pre-heating
#   - Based on lookahead, starts heating before the nozzle arrives
#   - Set based on your hotend's thermal response time
variable_ooze_preheat_distance: 5.0
#
# SMART RETRACTION
# ----------------
# When temperature is boosted, filament is more fluid and needs more retraction.
# Smart Retraction dynamically adjusts retraction based on current temp boost.
#
# smart_retraction_enabled: Enable/disable dynamic retraction adjustment
variable_smart_retraction_enabled: True
#
# smart_retraction_base: Your normal retraction distance (mm)
#   - This is your baseline retraction at base temperature
#   - Direct drive: typically 0.4-1.0mm
#   - Bowden: typically 2-6mm
variable_smart_retraction_base: 0.6
#
# smart_retraction_per_degree: Extra retraction per °C of boost (mm/°C)
#   - How much extra retraction to add per degree of temperature boost
#   - 0.02 = 0.2mm extra retraction for 10°C boost
#   - Start conservative and increase if you see oozing
variable_smart_retraction_per_degree: 0.02
#
# smart_retraction_max: Maximum total retraction (mm)
#   - Safety limit to prevent excessive retraction
#   - Should be ~2x your base retraction for direct drive
#   - Should be ~1.5x for bowden
variable_smart_retraction_max: 1.2
#
# smart_retraction_speed: Retraction speed (mm/s)
#   - Speed for the smart retraction move
variable_smart_retraction_speed: 35.0
#
# ZERO-CONFIG / AUTO-LEARNING
# ----------------------------
# auto_calibrate_enabled: Automatically calibrate baseline on first print
#   - If no saved baseline exists, samples during initial extrusion
variable_auto_calibrate_enabled: True
#
# auto_material_detect: Infer material type from slicer temperature
#   - Eliminates need for MATERIAL= parameter
variable_auto_material_detect: True
#
# self_learning_enabled: Auto-adjust K-values based on thermal response
#   - Learns optimal settings over time
variable_self_learning_enabled: True
#
# learning_rate: How aggressively to adjust K-values (0.01-0.1)
#   - Lower = more stable, slower learning
#   - Higher = faster adaptation, may oscillate
variable_learning_rate: 0.05
#
# =========================================================
variable_current_boost: 0.0
variable_last_load_val: 0
variable_layer_crash_count: 0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_slowdown_layers_left: 0
variable_slowdown_active: False
variable_last_vol_flow: 0.0
variable_thermal_fault_count: 0
variable_last_thermal_check: 0.0
variable_ooze_mode_active: False
variable_last_smart_retract: 0.0
variable_auto_baseline_samples: 0
variable_auto_baseline_sum: 0
variable_auto_baseline_done: False
variable_detected_material: "UNKNOWN"
variable_thermal_lag_samples: 0
variable_thermal_lag_sum: 0.0
variable_enabled: False
variable_accumulated_travel: 0.0
variable_last_ooze_check: 0.0

gcode:
    # =========================================================
    #  READ CONFIGURATION FROM VARIABLES ABOVE
    # =========================================================
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set use_high_flow_nozzle = cfg.use_high_flow_nozzle %}
    
    # Sensor baseline: prefer saved (calibrated) value, fallback to config
    {% set vars = printer.save_variables.variables %}
    {% set sensor_baseline = vars.sensor_baseline|default(cfg.sensor_baseline)|int %}
    
    {% set noise_filter = cfg.noise_filter %}
    {% set crash_threshold = cfg.crash_threshold %}
    {% set flow_smoothing = cfg.flow_smoothing %}
    {% set max_boost_limit = cfg.max_boost_limit %}
    {% set ramp_rate_rise = cfg.ramp_rate_rise %}
    {% set ramp_rate_fall = cfg.ramp_rate_fall %}
    {% set thermal_runaway_threshold = cfg.thermal_runaway_threshold %}
    {% set thermal_undertemp_threshold = cfg.thermal_undertemp_threshold %}

    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # Auto-Calculate Flow Gate
    {% if use_high_flow_nozzle %}
        {% set min_flow_mm3 = 15.0 %}
    {% else %}
        {% set min_flow_mm3 = 8.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            _AT_EVALUATE_LAYER
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: BLOB DETECTION ---
        {% set load_val = printer["extruder_monitor"].load|default(0)|int %}
        {% set predicted_rate = printer["extruder_monitor"].predicted_extrusion_rate|default(0.0)|float %}
        {% set last_load = printer["gcode_macro _AUTO_TEMP_CORE"].last_load_val %}
        {% set load_delta = (last_load - load_val)|abs %}

        {% if filament_speed > 2.0 and load_delta > crash_threshold %}
            {% set current_crashes = printer["gcode_macro _AUTO_TEMP_CORE"].layer_crash_count %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE={current_crashes + 1}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_load_val VALUE={load_val}

        # --- B2: AUTO-BASELINE CALIBRATION ---
        # If no saved baseline exists and we're extruding, auto-sample
        # NOTE: StallGuard only activates above ~3.5mm/s filament speed (TSTEP < TCOOLTHRS)
        {% set has_saved_baseline = vars.sensor_baseline|default(-1)|int >= 0 %}
        {% set auto_cal_enabled = cfg.auto_calibrate_enabled %}
        {% set auto_baseline_done = cfg.auto_baseline_done %}
        
        {% if auto_cal_enabled and not has_saved_baseline and not auto_baseline_done %}
            {% if filament_speed > 4.0 and load_val > 5 %}
                # We're extruding fast enough for StallGuard - sample!
                {% set sample_count = cfg.auto_baseline_samples %}
                {% set sample_sum = cfg.auto_baseline_sum %}
                
                {% set new_count = sample_count + 1 %}
                {% set new_sum = sample_sum + load_val %}
                
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_samples VALUE={new_count}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_sum VALUE={new_sum}
                
                # After 20 samples, calculate and save baseline
                {% if new_count >= 20 %}
                    {% set calculated_baseline = (new_sum / new_count)|round|int %}
                    SAVE_VARIABLE VARIABLE=sensor_baseline VALUE={calculated_baseline}
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_done VALUE=True
                    RESPOND MSG="AUTO-CALIBRATION: Baseline set to {calculated_baseline} (from {new_count} samples)"
                {% elif new_count == 1 %}
                    RESPOND MSG="AUTO-CALIBRATION: Sampling baseline... (no saved value found)"
                {% endif %}
            {% endif %}
        {% endif %}

        # --- C: CALCULATE BOOST (Velocity + Acceleration) ---
        
        # 1. Calculate Flow
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        
        # 2. Smoothing (moved up so smooth_vol_flow is available for later calculations)
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}
        
        # 3. ACCELERATION KICK (Predictive Boost)
        # Calculate how fast the flow is changing
        {% set flow_accel = raw_vol_flow - last_vol_flow %}
        
        # If accelerating hard (positive change), add a temp kick
        {% set accel_boost = 0.0 %}
        {% if flow_accel > 2.0 %}
            # Add 2C boost for every 1mm3/s of acceleration
            {% set accel_boost = flow_accel * 2.0 %}
        {% endif %}

        # 4. LOOKAHEAD BOOST (Predictive from upcoming G-code)
        # predicted_rate is in mm/s filament; convert to approx vol flow (mm3/s)
        {% set predicted_vol_flow = predicted_rate * 2.405 %}
        {% set lookahead_boost = 0.0 %}
        {% if predicted_vol_flow > smooth_vol_flow %}
            # Upcoming extrusion is faster than current — pre-heat
            {% set lookahead_delta = predicted_vol_flow - smooth_vol_flow %}
            # 1C per 2 mm3/s predicted increase (tunable)
            {% set lookahead_boost = lookahead_delta * 0.5 %}
        {% endif %}

        # 5. Standard Boost
        {% set speed_k = vars.material_flow_k|default(0.0)|float %}
        
        # Gated Logic
        {% if smooth_vol_flow < min_flow_mm3 %}
            {% set speed_boost = 0.0 %}
        {% else %}
            {% set speed_boost = smooth_vol_flow * speed_k %}
        {% endif %}

        # 6. Strain Boost
        {% set board_temp = 35.0 %}
        {% if 'temperature_sensor Toolhead_Temp' in printer %}
            {% set board_temp = printer['temperature_sensor Toolhead_Temp'].temperature|float %}
        {% elif 'temperature_sensor mcu_temp' in printer %}
             {% set board_temp = printer['temperature_sensor mcu_temp'].temperature|float %}
        {% endif %}

        {% set corrected_load = load_val + ((board_temp - 35.0) * 0.4) %}
        {% if corrected_load < 0 %} {% set corrected_load = 0 %} {% endif %}
        {% set strain = sensor_baseline - corrected_load %}
        {% if strain < noise_filter %} {% set strain = 0 %} {% endif %}
        {% set load_boost = strain * vars.material_viscosity_k|default(0.0)|float %}

        # --- D: SMOOTHING & RAMPING ---
        
        # Add Accel Boost + Lookahead Boost to the target
        {% set raw_boost_target = speed_boost + load_boost + accel_boost + lookahead_boost %}
        
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        # Linear Ramp Safety
        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}
        
        # --- E: OOZE PREVENTION ---
        {% set ooze_enabled = cfg.ooze_prevention_enabled %}
        {% set ooze_threshold = cfg.ooze_travel_threshold %}
        {% set ooze_drop = cfg.ooze_temp_drop %}
        {% set pending_travel = printer["extruder_monitor"].pending_travel|default(0)|float %}
        {% set in_travel = printer["extruder_monitor"].in_travel|default(False) %}
        {% set ooze_active = printer["gcode_macro _AUTO_TEMP_CORE"].ooze_mode_active %}
        
        {% set final_boost = smooth_boost %}
        
        {% if ooze_enabled %}
            {% if in_travel and pending_travel >= ooze_threshold %}
                # Long travel detected - drop temperature
                {% if not ooze_active %}
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=ooze_mode_active VALUE=True
                {% endif %}
                # Reduce boost by ooze_drop amount (can go negative relative to base)
                {% set final_boost = smooth_boost - ooze_drop %}
                {% if final_boost < (0 - ooze_drop) %}
                    {% set final_boost = 0 - ooze_drop %}
                {% endif %}
            {% elif ooze_active and not in_travel %}
                # Travel ended, extrusion resuming - restore temperature
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=ooze_mode_active VALUE=False
                # Boost is already calculated normally, just apply it
            {% elif ooze_active and predicted_rate > 0 %}
                # Still in travel but lookahead shows extrusion coming - pre-heat
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=ooze_mode_active VALUE=False
            {% endif %}
        {% endif %}
        
        # --- F: APPLY TEMPERATURE ---
        {% set new_target = (saved_base + final_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}
        {% if new_target < (saved_base - ooze_drop) %} {% set new_target = (saved_base - ooze_drop)|int %} {% endif %}

        {% if load_val != -1 %}
            {% set temp_diff = (new_target - current_setpoint)|abs %}
            {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}
        {% endif %}

        # --- G: THERMAL SAFETY CHECK ---
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set target_temp = printer.extruder.target|float %}
        {% set temp_deviation = actual_temp - target_temp %}
        
        # Check for thermal runaway (temp too high)
        {% if temp_deviation > thermal_runaway_threshold %}
            {% set fault_count = printer["gcode_macro _AUTO_TEMP_CORE"].thermal_fault_count + 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE={fault_count}
            
            {% if fault_count >= 3 %}
                # Multiple consecutive faults - emergency shutdown
                _AT_THERMAL_EMERGENCY reason="RUNAWAY" actual={actual_temp} target={target_temp}
            {% else %}
                # Single fault - reduce boost and warn
                RESPOND TYPE=error MSG="THERMAL WARNING: Temp {actual_temp}C exceeds target {target_temp}C by {temp_deviation|round(1)}C"
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
                M104 S{saved_base|int}  ; Drop to base temp immediately
            {% endif %}
        
        # Check for undertemp (heater not keeping up)
        {% elif temp_deviation < (0 - thermal_undertemp_threshold) %}
            RESPOND TYPE=echo MSG="THERMAL NOTICE: Temp {actual_temp}C is {(0-temp_deviation)|round(1)}C below target. Heater may be struggling."
            # Don't add more boost if heater can't keep up - reduce demand
            {% if smooth_boost > 10 %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost * 0.5}
            {% endif %}
        
        {% else %}
            # Temp is within safe range - reset fault counter
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
        {% endif %}

        # --- H: SELF-LEARNING K-VALUE ADJUSTMENT ---
        # Monitors thermal response and adjusts K-values to optimize over time
        {% set self_learn = cfg.self_learning_enabled %}
        {% set learn_rate = cfg.learning_rate %}
        
        {% if self_learn and smooth_boost > 1.0 %}
            # We're actively boosting - monitor how well temp follows
            {% set thermal_error = target_temp - actual_temp %}  # Positive = too cold
            
            # Only learn when we have significant demand
            {% if smooth_vol_flow > min_flow_mm3 %}
                {% set lag_samples = cfg.thermal_lag_samples %}
                {% set lag_sum = cfg.thermal_lag_sum %}
                
                # Track thermal error for learning
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE={lag_samples + 1}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE={lag_sum + thermal_error}
                
                # Every 50 samples, evaluate and potentially adjust
                {% if lag_samples > 0 and (lag_samples % 50) == 0 %}
                    {% set avg_error = lag_sum / lag_samples %}
                    
                    {% if avg_error > 3.0 %}
                        # Consistently too cold - heater can't keep up
                        # Increase speed_k to boost temp earlier
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k + learn_rate %}
                        {% if new_speed_k > 2.0 %}
                            {% set new_speed_k = 2.0 %}  # Cap at reasonable max
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg thermal lag {avg_error|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% elif avg_error < -3.0 %}
                        # Consistently too hot - reduce boost aggressiveness
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k - learn_rate %}
                        {% if new_speed_k < 0.1 %}
                            {% set new_speed_k = 0.1 %}  # Don't go below minimum
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg overshoot {(0-avg_error)|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% endif %}
                    
                    # Reset for next learning window
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
                {% endif %}
            {% endif %}
        {% endif %}

        # Pressure Advance
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if base_pa > 0 %}
            {% set pa_multiplier = 1.0 - (smooth_boost * 0.01) %}
            {% if pa_multiplier < 0.5 %} {% set pa_multiplier = 0.5 %} {% endif %}
            {% set new_pa = base_pa * pa_multiplier %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.01 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. EVALUATION LOGIC
# =========================================================
[gcode_macro _AT_EVALUATE_LAYER]
description: Internal - Decides if the last layer was bad
gcode:
    {% set macro_vars = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set crashes = macro_vars.layer_crash_count %}
    {% set CRASH_LIMIT = 3 %} 
    
    {% if crashes > CRASH_LIMIT %}
        RESPOND TYPE=error MSG="Auto-Temp: Surface Defects Detected ({crashes} spikes). Slowing down."
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=3
        
        {% if not macro_vars.slowdown_active %}
            M220 S50 ; Drop to 50% Speed
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=True
        {% endif %}
        
    {% else %}
        {% if macro_vars.slowdown_layers_left > 0 %}
            {% set remaining = macro_vars.slowdown_layers_left - 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE={remaining}
            
            {% if remaining == 0 %}
                RESPOND MSG="Auto-Temp: Stability restored. Resuming 100% speed."
                M220 S100
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
            {% endif %}
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0

# =========================================================
#  2b. THERMAL SAFETY
# =========================================================
[gcode_macro _AT_THERMAL_EMERGENCY]
description: Emergency thermal shutdown - called when runaway detected
gcode:
    {% set reason = params.REASON|default("UNKNOWN")|string %}
    {% set actual = params.ACTUAL|default(0)|float %}
    {% set target = params.TARGET|default(0)|float %}
    
    # Immediately disable auto-temp
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    
    # Turn off heater (set to 0)
    M104 S0
    
    # Pause print
    PAUSE
    
    # Alert user
    RESPOND TYPE=error MSG="!!! THERMAL EMERGENCY !!!"
    RESPOND TYPE=error MSG="Reason: {reason}"
    RESPOND TYPE=error MSG="Actual: {actual}C | Target: {target}C"
    RESPOND TYPE=error MSG="Heater OFF - Print PAUSED - Auto-Temp DISABLED"
    RESPOND TYPE=error MSG="Check hotend and thermistor before resuming!"
    
    M117 THERMAL EMERGENCY - CHECK HOTEND!

[gcode_macro AT_THERMAL_STATUS]
description: Display current thermal safety status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set actual = printer.extruder.temperature|float %}
    {% set target = printer.extruder.target|float %}
    {% set base = vars.base_print_temp|default(0)|float %}
    {% set boost = cfg.current_boost %}
    {% set faults = cfg.thermal_fault_count %}
    
    {% set deviation = actual - target %}
    {% set runaway_limit = cfg.thermal_runaway_threshold %}
    {% set undertemp_limit = cfg.thermal_undertemp_threshold %}
    
    RESPOND MSG="===== THERMAL STATUS ====="
    RESPOND MSG="Actual: {actual|round(1)}C | Target: {target|round(1)}C"
    RESPOND MSG="Base: {base|round(1)}C | Boost: +{boost|round(1)}C"
    RESPOND MSG="Deviation: {deviation|round(1)}C"
    RESPOND MSG="Limits: Runaway +{runaway_limit}C | Undertemp -{undertemp_limit}C"
    RESPOND MSG="Fault Count: {faults}/3"
    {% if vars.at_enabled|default(False) %}
        RESPOND MSG="Status: ACTIVE"
    {% else %}
        RESPOND MSG="Status: DISABLED"
    {% endif %}
    RESPOND MSG="=========================="

[gcode_macro AT_STATUS]
description: Display full Adaptive Flow system status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    
    # System state
    {% set enabled = vars.at_enabled|default(False) %}
    {% set base_temp = vars.base_print_temp|default(0)|float %}
    {% set max_temp = vars.at_max_temp|default(300)|int %}
    {% set flow_k = vars.material_flow_k|default(0)|float %}
    {% set visc_k = vars.material_viscosity_k|default(0)|float %}
    
    # Current values from macro state
    {% set boost = cfg.current_boost %}
    {% set last_load = cfg.last_load_val %}
    {% set crash_count = cfg.layer_crash_count %}
    {% set fault_count = cfg.thermal_fault_count %}
    {% set slowdown = cfg.slowdown_active|default(False) %}
    
    # Configuration
    {% set use_hf = cfg.use_high_flow_nozzle %}
    {% set baseline = cfg.sensor_baseline %}
    {% set noise = cfg.noise_filter %}
    {% set crash_thresh = cfg.crash_threshold %}
    
    # Thermal info
    {% set actual_temp = printer.extruder.temperature|float %}
    {% set target_temp = printer.extruder.target|float %}
    {% set current_pa = printer.extruder.pressure_advance|default(0)|float %}
    {% set base_pa = cfg.base_pa|default(0)|float %}
    
    # Try to get extruder monitor data
    {% set load_val = printer.extruder_monitor.load|default(-1)|int %}
    {% set predicted = printer.extruder_monitor.predicted_extrusion_rate|default(0)|float %}
    
    RESPOND MSG="╔═══════════════════════════════════════════╗"
    RESPOND MSG="║      ADAPTIVE FLOW STATUS                 ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    
    # System State
    {% if enabled %}
        RESPOND MSG="║ System: ✓ ENABLED                         ║"
    {% else %}
        RESPOND MSG="║ System: ✗ DISABLED                        ║"
    {% endif %}
    
    # Hotend Type
    {% if use_hf %}
        RESPOND MSG="║ Hotend: Revo HF (15mm³/s gate)            ║"
    {% else %}
        RESPOND MSG="║ Hotend: Revo Standard (8mm³/s gate)       ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ TEMPERATURE                               ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Actual:    {"%6.1f"|format(actual_temp)}°C                        ║"
    RESPOND MSG="║ Target:    {"%6.1f"|format(target_temp)}°C                        ║"
    RESPOND MSG="║ Base:      {"%6.1f"|format(base_temp)}°C                        ║"
    RESPOND MSG="║ Boost:     {"%+6.1f"|format(boost)}°C                        ║"
    RESPOND MSG="║ Max Limit: {"%6d"|format(max_temp)}°C                        ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ PRESSURE ADVANCE                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Current PA: {"%6.3f"|format(current_pa)}                         ║"
    RESPOND MSG="║ Base PA:    {"%6.3f"|format(base_pa)}                         ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SENSOR & LOAD                             ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Baseline:     {"%4d"|format(baseline)}                          ║"
    {% if load_val >= 0 %}
        RESPOND MSG="║ Current SG:   {"%4d"|format(load_val)}                          ║"
        {% set strain = baseline - load_val %}
        RESPOND MSG="║ Strain Delta: {"%+4d"|format(strain)}                          ║"
    {% else %}
        RESPOND MSG="║ Current SG:   N/A (driver not ready)       ║"
    {% endif %}
    RESPOND MSG="║ Noise Filter: {"%4d"|format(noise)}                          ║"
    RESPOND MSG="║ Crash Thresh: {"%4d"|format(crash_thresh)}                          ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ FLOW & LOOKAHEAD                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Flow K:    {"%6.2f"|format(flow_k)}                           ║"
    RESPOND MSG="║ Visc K:    {"%6.2f"|format(visc_k)}                           ║"
    {% if predicted > 0 %}
        RESPOND MSG="║ Predicted: {"%6.2f"|format(predicted)} mm/s                    ║"
    {% else %}
        RESPOND MSG="║ Predicted: ------ (no lookahead data)      ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ OOZE PREVENTION                           ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set ooze_enabled = cfg.ooze_prevention_enabled %}
    {% set ooze_active = cfg.ooze_mode_active|default(False) %}
    {% set pending_travel = printer.extruder_monitor.pending_travel|default(0)|float %}
    {% if ooze_enabled %}
        RESPOND MSG="║ Ooze Prev:    ✓ ENABLED                    ║"
    {% else %}
        RESPOND MSG="║ Ooze Prev:    ✗ DISABLED                   ║"
    {% endif %}
    {% if ooze_active %}
        RESPOND MSG="║ Status:       TEMP DROPPED                 ║"
    {% else %}
        RESPOND MSG="║ Status:       NORMAL                       ║"
    {% endif %}
    RESPOND MSG="║ Travel Accum: {"%6.1f"|format(pending_travel)} mm                   ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SMART RETRACTION                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set sr_enabled = cfg.smart_retraction_enabled %}
    {% set sr_base = cfg.smart_retraction_base %}
    {% set sr_per_deg = cfg.smart_retraction_per_degree %}
    {% set sr_max = cfg.smart_retraction_max %}
    {% set sr_calc = sr_base + (boost * sr_per_deg) %}
    {% if sr_calc > sr_max %}{% set sr_calc = sr_max %}{% endif %}
    {% if sr_enabled %}
        RESPOND MSG="║ Smart Retr:   ✓ ENABLED                    ║"
    {% else %}
        RESPOND MSG="║ Smart Retr:   ✗ DISABLED                   ║"
    {% endif %}
    RESPOND MSG="║ Base:         {"%5.2f"|format(sr_base)}mm                       ║"
    RESPOND MSG="║ Calculated:   {"%5.2f"|format(sr_calc)}mm                       ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SAFETY & EVENTS                           ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Thermal Faults: {fault_count}/3                        ║"
    RESPOND MSG="║ Layer Crashes:  {crash_count}                           ║"
    {% if slowdown %}
        RESPOND MSG="║ Slowdown Mode:  ACTIVE                      ║"
    {% else %}
        RESPOND MSG="║ Slowdown Mode:  OFF                         ║"
    {% endif %}
    
    RESPOND MSG="╚═══════════════════════════════════════════╝"

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=ooze_mode_active VALUE=False
    M220 S100
    RESPOND MSG="Auto-Temp: State reset complete"

    
[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_VISC_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_OOZE_PREVENTION]
description: Enable or disable ooze prevention
gcode:
    {% set enable = params.ENABLE|default("toggle")|string|lower %}
    {% set current = printer["gcode_macro _AUTO_TEMP_CORE"].ooze_prevention_enabled %}
    
    {% if enable == "toggle" %}
        {% set new_state = not current %}
    {% elif enable in ["1", "true", "on", "yes"] %}
        {% set new_state = True %}
    {% else %}
        {% set new_state = False %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=ooze_prevention_enabled VALUE={new_state}
    {% if new_state %}
        RESPOND MSG="Ooze Prevention: ENABLED"
    {% else %}
        RESPOND MSG="Ooze Prevention: DISABLED"
    {% endif %}

# =========================================================
#  SMART RETRACTION MACROS
# =========================================================
[gcode_macro AT_SMART_RETRACT]
description: Dynamic retraction based on current temperature boost
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set enabled = cfg.smart_retraction_enabled %}
    
    {% if enabled %}
        {% set base = cfg.smart_retraction_base %}
        {% set per_deg = cfg.smart_retraction_per_degree %}
        {% set max_retract = cfg.smart_retraction_max %}
        {% set speed = cfg.smart_retraction_speed %}
        {% set boost = cfg.current_boost %}
        
        # Calculate dynamic retraction
        {% set extra = boost * per_deg %}
        {% set total = base + extra %}
        
        # Clamp to maximum
        {% if total > max_retract %}
            {% set total = max_retract %}
        {% endif %}
        
        # Store for unretract
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_smart_retract VALUE={total}
        
        # Execute retraction
        G91
        G1 E-{total} F{(speed * 60)|int}
        G90
    {% else %}
        # Fallback to base retraction
        {% set base = cfg.smart_retraction_base %}
        {% set speed = cfg.smart_retraction_speed %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_smart_retract VALUE={base}
        G91
        G1 E-{base} F{(speed * 60)|int}
        G90
    {% endif %}

[gcode_macro AT_SMART_UNRETRACT]
description: Unretract matching the last smart retraction amount
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set last_retract = cfg.last_smart_retract|default(cfg.smart_retraction_base)|float %}
    {% set speed = cfg.smart_retraction_speed %}
    
    # Unretract the same amount that was retracted
    G91
    G1 E{last_retract} F{(speed * 60)|int}
    G90
    
    # Reset tracker
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_smart_retract VALUE=0.0

[gcode_macro AT_SMART_RETRACTION]
description: Enable or disable smart retraction
gcode:
    {% set enable = params.ENABLE|default("toggle")|string|lower %}
    {% set current = printer["gcode_macro _AUTO_TEMP_CORE"].smart_retraction_enabled %}
    
    {% if enable == "toggle" %}
        {% set new_state = not current %}
    {% elif enable in ["1", "true", "on", "yes"] %}
        {% set new_state = True %}
    {% else %}
        {% set new_state = False %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=smart_retraction_enabled VALUE={new_state}
    {% if new_state %}
        RESPOND MSG="Smart Retraction: ENABLED"
    {% else %}
        RESPOND MSG="Smart Retraction: DISABLED"
    {% endif %}

[gcode_macro AT_SET_RETRACTION]
description: Configure smart retraction parameters
gcode:
    {% set base = params.BASE|default(-1)|float %}
    {% set per_deg = params.PER_DEGREE|default(-1)|float %}
    {% set max_val = params.MAX|default(-1)|float %}
    {% set speed = params.SPEED|default(-1)|float %}
    
    {% if base >= 0 %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=smart_retraction_base VALUE={base}
        RESPOND MSG="Smart Retraction Base: {base}mm"
    {% endif %}
    
    {% if per_deg >= 0 %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=smart_retraction_per_degree VALUE={per_deg}
        RESPOND MSG="Smart Retraction Per Degree: {per_deg}mm/°C"
    {% endif %}
    
    {% if max_val >= 0 %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=smart_retraction_max VALUE={max_val}
        RESPOND MSG="Smart Retraction Max: {max_val}mm"
    {% endif %}
    
    {% if speed >= 0 %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=smart_retraction_speed VALUE={speed}
        RESPOND MSG="Smart Retraction Speed: {speed}mm/s"
    {% endif %}
    
    # Show current values if no params
    {% if base < 0 and per_deg < 0 and max_val < 0 and speed < 0 %}
        {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
        RESPOND MSG="===== SMART RETRACTION CONFIG ====="
        RESPOND MSG="Enabled: {cfg.smart_retraction_enabled}"
        RESPOND MSG="Base: {cfg.smart_retraction_base}mm"
        RESPOND MSG="Per Degree: {cfg.smart_retraction_per_degree}mm/°C"
        RESPOND MSG="Max: {cfg.smart_retraction_max}mm"
        RESPOND MSG="Speed: {cfg.smart_retraction_speed}mm/s"
        RESPOND MSG="Current Boost: +{cfg.current_boost|round(1)}°C"
        {% set calc = cfg.smart_retraction_base + (cfg.current_boost * cfg.smart_retraction_per_degree) %}
        {% if calc > cfg.smart_retraction_max %}
            {% set calc = cfg.smart_retraction_max %}
        {% endif %}
        RESPOND MSG="Calculated Retraction: {calc|round(3)}mm"
        RESPOND MSG="===================================="
    {% endif %}

[gcode_macro AT_CHECK_BASELINE]
description: Manual baseline check (legacy) - shows SG values during extrusion
gcode:
    {% set temp = params.TEMP|default(220)|int %}
    M117 Heating to {temp}C...
    M109 S{temp}
    M117 Extruding FAST (50mm/s)...
    G91
    G1 E100 F3000 
    G90
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    M117 Done. Note the SG_RESULT values.

[gcode_macro AT_AUTO_CALIBRATE]
description: Automatic baseline calibration - heats, extrudes, samples, and saves
gcode:
    {% set temp = params.TEMP|default(220)|int %}
    {% set extrude_length = params.LENGTH|default(50)|int %}
    {% set num_samples = params.SAMPLES|default(10)|int %}
    
    RESPOND MSG="Auto-Calibrate: Starting baseline calibration..."
    
    # Heat and wait
    M117 Heating to {temp}C...
    M109 S{temp}
    G4 P2000  ; Wait 2s for temp to stabilize
    
    # Start calibration
    CALIBRATE_BASELINE
    
    # Extrude and sample
    M117 Extruding and sampling...
    G91  ; Relative positioning
    
    # Calculate extrusion per sample
    {% set e_per_sample = (extrude_length / num_samples)|round(2) %}
    {% set feedrate = 1500 %}  ; 25mm/s - moderate extrusion speed
    
    # Extrude in chunks, sampling after each
    {% for i in range(num_samples) %}
        G1 E{e_per_sample} F{feedrate}
        G4 P200  ; Brief pause for SG to settle
        SAMPLE_LOAD
    {% endfor %}
    
    G90  ; Absolute positioning
    
    # Finish and calculate
    FINISH_CALIBRATION
    
    M117 Calibration complete!
    RESPOND MSG="Auto-Calibrate: Done! See console for baseline value."
    RESPOND MSG="Run: SAVE_VARIABLE VARIABLE=sensor_baseline VALUE=<value> to save"

[gcode_macro AT_INIT_MATERIAL]
description: Logic to set K-values and PA based on material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Read hotend type from shared config variable in _AUTO_TEMP_CORE
    {% set use_hf = printer["gcode_macro _AUTO_TEMP_CORE"].use_high_flow_nozzle %}
    
    # =========================================================
    # DEFAULT PA VALUES (used if user hasn't calibrated)
    # These are reasonable starting points - calibrate for best results!
    # =========================================================
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    # Defaults for other settings
    {% set load_k = 0.0 %}
    {% set speed_k = 0.0 %}
    {% set max_temp_safety = 300 %}

    # =========================================================
    # GET PA: User-calibrated value OR default
    # =========================================================
    # Check for exact material match first, then partial match
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    {% if saved_pa >= 0 %}
        # User has calibrated this material
        {% set pa_val = saved_pa %}
        {% set pa_source = "calibrated" %}
    {% else %}
        # Use default - check for partial match in material name
        {% set pa_val = 0.0 %}
        {% set pa_source = "default" %}
        {% for mat_name, mat_pa in default_pa.items() %}
            {% if mat_name in material %}
                {% set pa_val = mat_pa %}
            {% endif %}
        {% endfor %}
    {% endif %}

    # --- PLA LOGIC ---
    {% if 'PLA' in material %}
        {% if use_hf %}
            {% set load_k = 0.60 %}
            {% set speed_k = 0.80 %}
            {% set max_temp_safety = 235 %}
        {% else %}
            {% set load_k = 0.25 %}
            {% set speed_k = 0.40 %} 
            {% set max_temp_safety = 235 %}
        {% endif %}

    # --- PETG LOGIC ---
    {% elif 'PETG' in material %}
        {% if use_hf %}
            {% set load_k = 0.80 %}
            {% set speed_k = 1.20 %}
            {% set max_temp_safety = 280 %}
        {% else %}
            {% set load_k = 0.60 %}
            {% set speed_k = 1.00 %}
            {% set max_temp_safety = 265 %}
        {% endif %}

    # --- ABS/ASA LOGIC ---
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set load_k = 0.20 %}
        {% set speed_k = 0.80 %}
        {% set max_temp_safety = 290 %}
        
    # --- TPU LOGIC ---
    {% elif 'TPU' in material %}
        {% set load_k = 0.0 %}  # Disable load-based boost for flexible
        {% set speed_k = 0.0 %}
        {% set max_temp_safety = 240 %}
        
    # --- NYLON LOGIC ---
    {% elif 'NYLON' in material %}
        {% set load_k = 0.40 %}
        {% set speed_k = 0.90 %}
        {% set max_temp_safety = 275 %}
        
    # --- PC LOGIC ---
    {% elif 'PC' in material %}
        {% set load_k = 0.30 %}
        {% set speed_k = 0.70 %}
        {% set max_temp_safety = 300 %}
    {% endif %}

    # --- APPLY ---
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
        RESPOND MSG="PA: {pa_val} ({pa_source})"
    {% endif %}

    {% if load_k > 0 or speed_k > 0 %}
        AT_SET_VISC_K K={load_k}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material})"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"
    {% endif %}

# =========================================================
#  PA CALIBRATION MACROS
# =========================================================
[gcode_macro AT_SET_PA]
description: Save calibrated PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper|replace(" ", "_") %}
    {% set pa = params.PA|default(0.04)|float %}
    
    {% if pa < 0 or pa > 1.0 %}
        RESPOND TYPE=error MSG="PA value must be between 0 and 1.0"
    {% else %}
        SAVE_VARIABLE VARIABLE=pa_{material|lower} VALUE={pa}
        RESPOND MSG="Saved PA for {material}: {pa}"
        RESPOND MSG="This will be used next time you run AT_INIT_MATERIAL MATERIAL={material}"
    {% endif %}

[gcode_macro AT_GET_PA]
description: Show saved or default PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    RESPOND MSG="===== PA for {material} ====="
    {% if saved_pa >= 0 %}
        RESPOND MSG="Saved (calibrated): {saved_pa}"
    {% else %}
        RESPOND MSG="Saved: None (not calibrated)"
    {% endif %}
    
    {% set def_val = default_pa[material]|default(0)|float %}
    {% if def_val > 0 %}
        RESPOND MSG="Default: {def_val}"
    {% else %}
        RESPOND MSG="Default: None (unknown material)"
    {% endif %}
    
    {% if saved_pa >= 0 %}
        RESPOND MSG="Will use: {saved_pa} (calibrated)"
    {% elif def_val > 0 %}
        RESPOND MSG="Will use: {def_val} (default)"
    {% else %}
        RESPOND MSG="Will use: 0 (no PA)"
    {% endif %}

[gcode_macro AT_LIST_PA]
description: List all saved PA values and defaults
gcode:
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    RESPOND MSG="===== PRESSURE ADVANCE VALUES ====="
    RESPOND MSG="Material | Saved | Default"
    RESPOND MSG="---------|-------|--------"
    {% for mat, def_pa in default_pa.items() %}
        {% set saved = vars["pa_" ~ mat|lower]|default(-1)|float %}
        {% if saved >= 0 %}
            RESPOND MSG="{mat}: {saved} (calibrated) | {def_pa}"
        {% else %}
            RESPOND MSG="{mat}: - | {def_pa}"
        {% endif %}
    {% endfor %}
    RESPOND MSG="===================================="
    RESPOND MSG="To calibrate: AT_SET_PA MATERIAL=<name> PA=<value>"
# =========================================================================
# ZERO-CONFIG ENTRY POINT
# =========================================================================
# AT_START: The ONLY macro you need in your slicer's start g-code!
# This automatically detects material from temperature, applies appropriate
# K-values and PA, and enables adaptive flow. True plug-and-play.
# =========================================================================

[gcode_macro AT_START]
description: Zero-config adaptive temperature - just call this in your start g-code!
gcode:
    # Get extruder target temperature (set by slicer before this macro runs)
    {% set target_temp = printer.extruder.target|default(0)|int %}
    {% set vars = printer.save_variables.variables %}
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    
    # Warn if no temperature set (AT_START called before heating commands)
    {% if target_temp < 150 %}
        RESPOND TYPE=echo MSG="AT_START: Warning - extruder target is {target_temp}C. Call AT_START AFTER your heating commands (M104/M109)."
        {% set target_temp = 200 %}  # Default to PLA temp
    {% endif %}
    
    # Auto-detect material from temperature if enabled
    {% set auto_detect = cfg.auto_material_detect %}
    {% set detected = "PLA" %}  # Default fallback
    
    {% if auto_detect %}
        # Temperature-based material detection
        # Ranges overlap slightly - we pick the most common material for that temp
        {% if target_temp >= 280 %}
            {% set detected = "PC" %}        # 280-310°C: Polycarbonate
        {% elif target_temp >= 260 %}
            {% set detected = "NYLON" %}     # 260-280°C: Nylon
        {% elif target_temp >= 240 %}
            {% set detected = "ABS" %}       # 240-270°C: ABS/ASA
        {% elif target_temp >= 220 %}
            {% set detected = "PETG" %}      # 220-245°C: PETG
        {% elif target_temp >= 180 %}
            {% set detected = "PLA" %}       # 180-220°C: PLA
        {% elif target_temp >= 160 %}
            {% set detected = "TPU" %}       # 160-230°C: TPU (low end hint)
        {% else %}
            {% set detected = "PLA" %}       # Default
        {% endif %}
        
        # Store detected material
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=detected_material VALUE="'{detected}'"
        
        RESPOND MSG="AT_START: Detected material '{detected}' from temp {target_temp}°C"
    {% endif %}
    
    # Check if we have a saved baseline
    {% set has_baseline = vars.sensor_baseline|default(-1)|int >= 0 %}
    {% if not has_baseline %}
        RESPOND MSG="AT_START: No calibration found - will auto-calibrate during first extrusion"
        # Reset auto_baseline_done flag in case user deleted saved baseline to recalibrate
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_done VALUE=False
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_samples VALUE=0
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_sum VALUE=0
    {% else %}
        RESPOND MSG="AT_START: Using saved baseline {vars.sensor_baseline}"
    {% endif %}
    
    # Initialize material settings (K-values, PA, safety limits)
    AT_INIT_MATERIAL MATERIAL={detected}
    
    # Enable adaptive flow
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=True
    
    RESPOND MSG="AT_START: Adaptive Temperature enabled for {detected}"

[gcode_macro AT_END]
description: Clean shutdown of adaptive temperature at print end
gcode:
    # Disable adaptive flow
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=False
    
    # Report any learned values if self-learning was active
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set lag_samples = cfg.thermal_lag_samples %}
    
    {% if lag_samples > 0 %}
        {% set avg_lag = cfg.thermal_lag_sum / lag_samples %}
        RESPOND MSG="AT_END: Avg thermal error: {avg_lag|round(2)}C over {lag_samples} samples (negative=overshoot)"
    {% endif %}
    
    # Reset per-print state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_ooze_check VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=accumulated_travel VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_samples VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=auto_baseline_sum VALUE=0
    # Note: auto_baseline_done is NOT reset - it stays True once calibration completes
    # To recalibrate, user must delete saved baseline and set auto_baseline_done=False
    
    RESPOND MSG="AT_END: Adaptive Temperature disabled"